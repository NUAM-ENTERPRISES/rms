generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model RefreshToken {
  id        String    @id @default(cuid())
  familyId  String
  userId    String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())
  hash      String
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([familyId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model User {
  id                               String                         @id @default(cuid())
  email                            String                         @unique
  name                             String
  password                         String
  dateOfBirth                      DateTime?
  otp                              String?
  otpExpiresAt                     DateTime?
  createdAt                        DateTime                       @default(now())
  updatedAt                        DateTime                       @updatedAt
  countryCode                      String
  profileImage                     String?
  mobileNumber                     String
  auditLogs                        AuditLog[]
  notifications                    Notification[]
  createdProjects                  Project[]                      @relation("ProjectCreator")
  refreshTokens                    RefreshToken[]
  transferRequestsApproved         TeamTransferRequest[]          @relation("TransferApprover")
  transferRequestsRequested        TeamTransferRequest[]          @relation("TransferRequester")
  transferRequestsReceived         TeamTransferRequest[]          @relation("TransferUser")
  userRoles                        UserRole[]
  userTeams                        UserTeam[]
  candidateProjectMaps             CandidateProjects[]
  candidateRecruiterAssignments    CandidateRecruiterAssignment[]
  assignedByRecruiterAssignments   CandidateRecruiterAssignment[] @relation("AssignedByUser")
  unassignedByRecruiterAssignments CandidateRecruiterAssignment[] @relation("UnassignedByUser")

  statusChanges               CandidateStatusHistory[]        @relation("UserToHistory")
  rnrReminders                RNRReminder[]                   @relation("RecruiterRNRReminders")
  projectStatusChanges        CandidateProjectStatusHistory[] @relation("UserToProjectStatusHistory")
  documentVerificationActions DocumentVerificationHistory[]   @relation("DocumentVerificationPerformer")

  @@unique([countryCode, mobileNumber])
  @@index([email])
  @@index([countryCode, mobileNumber])
  @@index([createdAt])
  @@map("users")
}

model Role {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@map("roles")
}

model Permission {
  id              String           @id @default(cuid())
  key             String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserRole {
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model Team {
  id                   String                @id @default(cuid())
  name                 String                @unique
  leadId               String?
  headId               String?
  managerId            String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  candidates           Candidate[]
  projects             Project[]
  transferRequestsFrom TeamTransferRequest[] @relation("FromTeamTransfers")
  transferRequestsTo   TeamTransferRequest[] @relation("ToTeamTransfers")
  userTeams            UserTeam[]

  @@map("teams")
}

model UserTeam {
  userId String
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, teamId])
  @@map("user_teams")
}

model Client {
  id                String                  @id @default(cuid())
  name              String
  pointOfContact    String?
  email             String?
  phone             String?
  address           String?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  acquisitionMethod AcquisitionMethod?
  agencyType        AgencyType?
  billingAddress    String?
  commissionRate    Float?
  contractEndDate   DateTime?
  contractStartDate DateTime?
  facilitySize      FacilitySize?
  facilityType      FacilityType?
  locations         Json                    @default("[]")
  organization      String?
  paymentTerms      String?
  profession        String?
  relationship      IndividualRelationship?
  relationshipType  RelationshipType?
  sourceName        String?
  sourceNotes       String?
  sourceType        ExternalSourceType?
  specialties       Json                    @default("[]")
  taxId             String?
  type              ClientType
  projects          Project[]

  @@map("clients")
}

model Country {
  code                          String                         @id
  name                          String
  region                        String
  callingCode                   String
  currency                      String
  timezone                      String
  isActive                      Boolean                        @default(true)
  createdAt                     DateTime                       @default(now())
  updatedAt                     DateTime                       @updatedAt
  projects                      Project[]
  qualificationCountryProfiles  QualificationCountryProfile[]
  qualificationEquivalencies    QualificationEquivalency[]
  roleRecommendedQualifications RoleRecommendedQualification[]

  @@map("countries")
}

model Project {
  id                   String                @id @default(cuid())
  clientId             String?
  title                String
  description          String?
  deadline             DateTime?
  status               String                @default("active")
  createdBy            String
  teamId               String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  priority             String                @default("medium")
  countryCode          String?
  projectType          String                @default("private") // "private" or "ministry"
  resumeEditable       Boolean               @default(true) // Whether resume can be edited according to requirements
  groomingRequired     String                @default("formal") // "formal", "casual", "not_specified"
  hideContactInfo      Boolean               @default(true) // Hide email and mobile in resume for private projects
  candidateProjects    CandidateProjects[]
  documentRequirements DocumentRequirement[]
  interviews           Interview[]
  client               Client?               @relation(fields: [clientId], references: [id])
  country              Country?              @relation(fields: [countryCode], references: [code])
  creator              User                  @relation("ProjectCreator", fields: [createdBy], references: [id])
  team                 Team?                 @relation(fields: [teamId], references: [id])
  rolesNeeded          RoleNeeded[]

  @@map("projects")
}

model RoleNeeded {
  id                        String                           @id @default(cuid())
  projectId                 String
  designation               String
  quantity                  Int
  priority                  String                           @default("medium")
  minExperience             Int?
  maxExperience             Int?
  skills                    Json                             @default("[]")
  createdAt                 DateTime                         @default(now())
  updatedAt                 DateTime                         @updatedAt
  additionalRequirements    String?
  backgroundCheckRequired   Boolean                          @default(true)
  benefits                  String?
  drugScreeningRequired     Boolean                          @default(true)
  educationRequirements     Json?
  institutionRequirements   String?
  languageRequirements      Json?
  licenseRequirements       Json?
  notes                     String?
  onCallRequired            Boolean                          @default(false)
  physicalDemands           String?
  relocationAssistance      Boolean                          @default(false)
  requiredCertifications    Json?
  salaryRange               Json?
  shiftType                 String?
  specificExperience        Json?
  employmentType            String                           @default("permanent") // "contract" or "permanent"
  contractDurationYears     Int? // Only applicable if employmentType is "contract"
  genderRequirement         String                           @default("all") // "female", "male", or "all"
  technicalSkills           Json?
  visaType                  String                           @default("contract") // "contract", "permanent", "work_permit", "student"
  requiredSkills            Json                             @default("[]") // Array of required skills
  candidateStates           Json                             @default("[]") // Array of allowed states for candidates
  candidateReligions        Json                             @default("[]") // Array of allowed religions for candidates
  minHeight                 Float? // Minimum height in cm
  maxHeight                 Float? // Maximum height in cm
  minWeight                 Float? // Minimum weight in kg
  maxWeight                 Float? // Maximum weight in kg
  candidateAllocations      CandidateProjects[]
  educationRequirementsList RoleNeededEducationRequirement[]
  project                   Project                          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_roles")
}

model Candidate {
  id                   String                         @id @default(cuid())
  email                String?
  source               String                         @default("manual")
  dateOfBirth          DateTime
  currentStatusId      Int?
  currentStatus        CandidateStatus?               @relation(fields: [currentStatusId], references: [id])
  experience           Int?
  skills               Json                           @default("[]")
  currentEmployer      String?
  expectedSalary       Int?
  createdAt            DateTime                       @default(now())
  updatedAt            DateTime                       @updatedAt
  teamId               String?
  profileImage         String?
  currentRole          String?
  currentSalary        Int?
  firstName            String
  gpa                  Float?
  graduationYear       Int?
  highestEducation     String?
  lastName             String
  totalExperience      Int?
  university           String?
  countryCode          String
  mobileNumber         String
  projects             CandidateProjects[]
  qualifications       CandidateQualification[]
  team                 Team?                          @relation(fields: [teamId], references: [id])
  certifications       Certification[]
  documents            Document[]
  talentPool           TalentPool?
  workExperiences      WorkExperience[]
  recruiterAssignments CandidateRecruiterAssignment[]
  statusHistories      CandidateStatusHistory[]       @relation("CandidateToHistory")
  rnrReminders         RNRReminder[]

  @@unique([countryCode, mobileNumber])
  @@index([teamId])
  @@index([currentStatusId])
  @@index([countryCode, mobileNumber])
  @@map("candidates")
}

model WorkExperience {
  id           String    @id @default(cuid())
  candidateId  String
  companyName  String
  jobTitle     String
  startDate    DateTime
  endDate      DateTime?
  isCurrent    Boolean   @default(false)
  description  String?
  salary       Int?
  location     String?
  skills       Json      @default("[]")
  achievements String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  candidate    Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([companyName])
  @@index([jobTitle])
  @@map("work_experiences")
}

model CandidateQualification {
  id              String        @id @default(cuid())
  candidateId     String
  qualificationId String
  university      String?
  graduationYear  Int?
  gpa             Float?
  isCompleted     Boolean       @default(true)
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  candidate       Candidate     @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  qualification   Qualification @relation(fields: [qualificationId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([qualificationId])
  @@map("candidate_qualifications")
}

model CandidateProjects {
  id           String   @id @default(cuid())
  candidateId  String
  projectId    String
  roleNeededId String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Current status tracking
  currentProjectStatusId Int                    @default(1) // Default to first status (e.g., "nominated")
  currentProjectStatus   CandidateProjectStatus @relation("CurrentProjectStatus", fields: [currentProjectStatusId], references: [id])

  mainStatusId String?
  mainStatus   CandidateProjectMainStatus? @relation(fields: [mainStatusId], references: [id])

  subStatusId String?
  subStatus   CandidateProjectSubStatus? @relation(fields: [subStatusId], references: [id])

  // Recruiter assignment
  assignedAt  DateTime?
  recruiterId String?
  recruiter   User?     @relation(fields: [recruiterId], references: [id])

  // Relations
  documentVerifications CandidateProjectDocumentVerification[]
  candidate             Candidate                              @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  project               Project                                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  roleNeeded            RoleNeeded?                            @relation(fields: [roleNeededId], references: [id])
  interviews            Interview[]
  processing            Processing?
  projectStatusHistory  CandidateProjectStatusHistory[]

  // Mock Interview & Training Relations
  mockInterviews      MockInterview[]
  trainingAssignments TrainingAssignment[]

  @@unique([candidateId, projectId, roleNeededId])
  @@index([currentProjectStatusId])
  @@index([mainStatusId])
  @@index([subStatusId])
  @@index([recruiterId])
  @@index([projectId, roleNeededId])
  @@map("candidate_projects")
}

model Document {
  id              String                                 @id @default(cuid())
  candidateId     String
  docType         String
  fileName        String
  fileUrl         String
  uploadedBy      String
  verifiedBy      String?

status          String   @default("pending") // "pending", "verified", "rejected"

  notes           String?
  createdAt       DateTime                               @default(now())
  updatedAt       DateTime                               @updatedAt

  documentNumber  String?
  expiryDate      DateTime?
  fileSize        Int?
  mimeType        String?

  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?
  verifiedAt      DateTime?

  verifications   CandidateProjectDocumentVerification[]
  candidate       Candidate                              @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([docType])
  @@index([status])
  @@map("documents")
}

model Interview {
  id                    String             @id @default(cuid())
  scheduledTime         DateTime
  duration              Int                @default(60)
  type                  String             @default("technical")
  outcome               String?
  notes                 String?
  interviewer           String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  candidateProjectMapId String?
  projectId             String?
  interviewerEmail      String?
  meetingLink           String?
  mode                  String?            @default("video")
  candidateProjectMap   CandidateProjects? @relation(fields: [candidateProjectMapId], references: [id], onDelete: Cascade)
  project               Project?           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([candidateProjectMapId])
  @@index([projectId])
  @@index([scheduledTime])
  @@map("interviews")
}

/// Mock Interview Coordination Feature Models
/// Added: January 2025

/// Mock Interview - Conducted by Interview Coordinators before client interviews
model MockInterview {
  id                    String @id @default(cuid())
  candidateProjectMapId String
  coordinatorId         String // Interview Coordinator who conducts the interview
  templateId            String? // Selected template for this interview

  // Scheduling
  scheduledTime DateTime?
  duration      Int       @default(60) // in minutes
  meetingLink   String?
  mode          String    @default("video") // video, phone, in-person

  // Assessment
  conductedAt        DateTime?
  overallRating      Int? // 1-5 scale
  decision           String? // approved, needs_training, rejected
  remarks            String?   @db.Text
  strengths          String?   @db.Text
  areasOfImprovement String?   @db.Text

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  candidateProjectMap CandidateProjects            @relation(fields: [candidateProjectMapId], references: [id], onDelete: Cascade)
  template            MockInterviewTemplate?       @relation(fields: [templateId], references: [id], onDelete: SetNull)
  checklistItems      MockInterviewChecklistItem[]
  trainingAssignments TrainingAssignment[]

  @@index([candidateProjectMapId])
  @@index([coordinatorId])
  @@index([templateId])
  @@index([scheduledTime])
  @@index([decision])
  @@map("mock_interviews")
}

/// Checklist items for each mock interview (filled during/after interview)
/// Links to template item if answer came from a template, otherwise custom question
model MockInterviewChecklistItem {
  id              String @id @default(cuid())
  mockInterviewId String
  templateItemId  String? // Optional: Link to template item if from template

  category  String // technical_skills, communication, professionalism, role_specific
  criterion String // What was evaluated
  passed    Boolean @default(false)
  rating    Int? // 1-5 scale
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mockInterview MockInterview @relation(fields: [mockInterviewId], references: [id], onDelete: Cascade)
  templateItem  MockInterviewTemplateItem? @relation(fields: [templateItemId], references: [id], onDelete: SetNull)

  @@index([mockInterviewId])
  @@index([templateItemId])
  @@index([category])
  @@map("mock_interview_checklist_items")
}

/// Mock Interview Template - A named collection of questions for a role
/// Interview Coordinators can create multiple templates per role
/// Each template contains questions organized by categories
model MockInterviewTemplate {
  id          String   @id @default(cuid())
  roleId      String
  role        RoleCatalog @relation(fields: [roleId], references: [id], onDelete: Cascade)

  name        String   // e.g., "Standard RN Interview Template"
  description String?  // Optional description
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items       MockInterviewTemplateItem[]
  mockInterviews MockInterview[]

  @@unique([roleId, name]) // Prevent duplicate template names for same role
  @@index([roleId])
  @@index([isActive])
  @@map("mock_interview_templates")
}

/// Questions/Criteria within a template, organized by category
/// Each template can have multiple categories, each category can have multiple questions
/// No duplicate categories within a single template (enforced by application logic)
model MockInterviewTemplateItem {
  id         String   @id @default(cuid())
  templateId String
  template   MockInterviewTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  category   String   // technical_skills, communication, professionalism, role_specific
  criterion  String   // The question/criterion to evaluate
  order      Int      @default(0) // Order within category

  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  checklistItems MockInterviewChecklistItem[] // Answers that used this template item

  @@unique([templateId, category, criterion]) // Prevent duplicate criteria in same category
  @@index([templateId])
  @@index([category])
  @@map("mock_interview_template_items")
}

/// Training/Screening assignments for candidates who need improvement
model TrainingAssignment {
  id                    String  @id @default(cuid())
  candidateProjectMapId String
  mockInterviewId       String? // Which mock interview triggered this
  assignedBy            String // Coordinator who assigned training

  // Training details
  trainingType String // interview_skills, technical, communication, role_specific
  focusAreas   String[] // Areas to improve
  priority     String   @default("medium") // high, medium, low
  status       String   @default("assigned") // assigned, in_progress, completed, cancelled

  // Dates
  assignedAt           DateTime  @default(now())
  startedAt            DateTime?
  completedAt          DateTime?
  targetCompletionDate DateTime?

  // Assessment after training
  notes            String? @db.Text
  improvementNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  candidateProjectMap CandidateProjects @relation(fields: [candidateProjectMapId], references: [id], onDelete: Cascade)
  mockInterview       MockInterview?    @relation(fields: [mockInterviewId], references: [id])
  trainingSessions    TrainingSession[]

  @@index([candidateProjectMapId])
  @@index([mockInterviewId])
  @@index([assignedBy])
  @@index([status])
  @@map("training_assignments")
}

/// Individual training sessions within a training assignment
model TrainingSession {
  id                   String @id @default(cuid())
  trainingAssignmentId String

  // Session details
  sessionDate       DateTime
  sessionType       String   @default("video") // video, phone, in_person
  duration          Int      @default(60) // in minutes
  topicsCovered     Json?    @db.Json // Array of topics
  plannedActivities String?  @db.Text
  trainer           String? // Who conducted the session

  // Completion & Assessment
  completedAt       DateTime?
  performanceRating String? // excellent, good, satisfactory, needs_improvement
  notes             String?   @db.Text
  feedback          String?   @db.Text // Feedback for candidate

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trainingAssignment TrainingAssignment @relation(fields: [trainingAssignmentId], references: [id], onDelete: Cascade)

  @@index([trainingAssignmentId])
  @@index([sessionDate])
  @@index([completedAt])
  @@map("training_sessions")
}

model Processing {
  id                    String            @id @default(cuid())
  qvpStatus             String            @default("not_started")
  medicalStatus         String            @default("not_started")
  visaStatus            String            @default("not_started")
  travelStatus          String            @default("not_started")
  notes                 String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  actualJoiningDate     DateTime?
  arrivalDate           DateTime?
  candidateProjectMapId String            @unique
  departureDate         DateTime?
  expectedJoiningDate   DateTime?
  flightBookedDate      DateTime?
  joiningNotes          String?
  joiningStatus         String            @default("pending")
  medicalClearance      String?
  medicalCompletionDate DateTime?
  medicalNotes          String?
  medicalStartDate      DateTime?
  qvpCompletionDate     DateTime?
  qvpStartDate          DateTime?
  travelNotes           String?
  visaApplicationDate   DateTime?
  visaApprovalDate      DateTime?
  visaExpiryDate        DateTime?
  visaNotes             String?
  visaType              String?
  candidateProjectMap   CandidateProjects @relation(fields: [candidateProjectMapId], references: [id], onDelete: Cascade)

  @@index([candidateProjectMapId])
  @@map("processing")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  seen      Boolean   @default(false)
  createdAt DateTime  @default(now())
  idemKey   String    @unique
  link      String?
  meta      Json?
  readAt    DateTime?
  status    String    @default("unread")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([type])
  @@index([status])
  @@map("notifications")
}

model OutboxEvent {
  id        String   @id @default(cuid())
  type      String
  payload   Json
  processed Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([type])
  @@index([processed])
  @@map("outbox_events")
}

model TeamTransferRequest {
  id          String    @id @default(cuid())
  userId      String
  fromTeamId  String
  toTeamId    String
  requestedBy String
  status      String    @default("pending")
  reason      String?
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  approver    User?     @relation("TransferApprover", fields: [approvedBy], references: [id])
  fromTeam    Team      @relation("FromTeamTransfers", fields: [fromTeamId], references: [id], onDelete: Cascade)
  requester   User      @relation("TransferRequester", fields: [requestedBy], references: [id], onDelete: Cascade)
  toTeam      Team      @relation("ToTeamTransfers", fields: [toTeamId], references: [id], onDelete: Cascade)
  user        User      @relation("TransferUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([fromTeamId])
  @@index([toTeamId])
  @@index([status])
  @@map("team_transfer_requests")
}

model Certification {
  id                 String    @id @default(cuid())
  candidateId        String
  certName           String
  status             String    @default("pending")
  examDate           DateTime?
  validUntil         DateTime?
  exportedToLearning Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  candidate          Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@map("certifications")
}

model TalentPool {
  id              String    @id @default(cuid())
  candidateId     String    @unique
  role            String
  yearsExperience Int
  currentEmployer String?
  isAvailable     Boolean   @default(true)
  rating          Int?
  notes           String?
  sourceProjectId String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  candidate       Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@map("talent_pool")
}

/// *
/// * DocumentRequirement
/// * Defines what documents are required for a specific project
/// * Set by recruiter/manager when creating/updating a project
model DocumentRequirement {
  id          String   @id @default(cuid())
  projectId   String
  docType     String
  mandatory   Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, docType])
  @@index([projectId])
  @@map("document_requirements")
}

/// *
/// * CandidateProjectDocumentVerification
/// * Junction table linking Documents to specific Project nominations
/// * Tracks verification status of each document for each project
/// * Multiple projects can reference the same document (e.g., same passport for multiple projects)
model CandidateProjectDocumentVerification {

  id                    String                        @id @default(cuid())
  candidateProjectMapId String
  documentId            String

  // Document status inside this project
  status                String   @default("pending") 
  // "pending" | "verified" | "rejected" | "resubmission_requested"
  
  notes                 String?
  rejectionReason       String?
  resubmissionRequested Boolean                       @default(false)

  createdAt             DateTime                      @default(now())
  updatedAt             DateTime                      @updatedAt

  candidateProjectMap   CandidateProjects             @relation(fields: [candidateProjectMapId], references: [id], onDelete: Cascade)
  document              Document                      @relation(fields: [documentId], references: [id], onDelete: Cascade)

  verificationHistory   DocumentVerificationHistory[]

  @@unique([candidateProjectMapId, documentId])
  @@index([candidateProjectMapId])
  @@index([documentId])
  @@index([status])
  @@map("candidate_project_document_verifications")
}

/// *
/// * DocumentVerificationHistory
/// * Tracks all verification actions on documents
/// * Records who performed the action, when, and why
model DocumentVerificationHistory {
  id              String                               @id @default(cuid())
  verificationId  String

  action          String // "verified", "rejected", "resubmission_requested", "pending"

  performedBy     String
  performedByName String?
  
  notes           String?
  reason          String?
  performedAt     DateTime                             @default(now())
  
  verification    CandidateProjectDocumentVerification @relation(fields: [verificationId], references: [id], onDelete: Cascade)
  performer       User                                 @relation("DocumentVerificationPerformer", fields: [performedBy], references: [id])

  @@index([verificationId])
  @@index([performedBy])
  @@index([action])
  @@index([performedAt])
  @@map("document_verification_history")
}

/// *
/// * ProjectRole
/// * Catalog of roles that can be assigned to projects
/// * Simple role definitions with name and category
model ProjectRole {
  id        String   @id @default(cuid())
  name      String   @unique
  category  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("project_role_catalog")
}

/// *
/// * RoleCatalog
/// * Normalized catalog of healthcare and general staff roles
/// * Separate from system RBAC roles (Role model)
model RoleCatalog {
  id                        String                         @id @default(cuid())
  name                      String                         @unique
  slug                      String                         @unique
  category                  String
  subCategory               String?
  isClinical                Boolean                        @default(true)
  description               String?
  isActive                  Boolean                        @default(true)
  createdAt                 DateTime                       @default(now())
  updatedAt                 DateTime                       @updatedAt
  recommendedQualifications RoleRecommendedQualification[]

  // Mock Interview Template Relations
  mockInterviewTemplates MockInterviewTemplate[]

  @@index([category])
  @@index([isClinical])
  @@index([isActive])
  @@map("role_catalog")
}

/// *
/// * Qualification
/// * Normalized catalog of educational qualifications, degrees, and certifications
model Qualification {
  id                      String                           @id @default(cuid())
  name                    String                           @unique
  shortName               String?
  level                   QualificationLevel
  field                   String
  program                 String?
  description             String?
  isActive                Boolean                          @default(true)
  createdAt               DateTime                         @default(now())
  updatedAt               DateTime                         @updatedAt
  candidateQualifications CandidateQualification[]
  aliases                 QualificationAlias[]
  countryProfiles         QualificationCountryProfile[]
  equivalencies           QualificationEquivalency[]       @relation("FromQualification")
  reverseEquivalencies    QualificationEquivalency[]       @relation("ToQualification")
  roleNeededRequirements  RoleNeededEducationRequirement[]
  roleRecommendations     RoleRecommendedQualification[]

  @@index([level])
  @@index([field])
  @@index([isActive])
  @@map("qualifications")
}

/// *
/// * QualificationAlias
/// * Alternative names for qualifications (e.g., "RN" for "Registered Nurse")
model QualificationAlias {
  id              String        @id @default(cuid())
  qualificationId String
  alias           String
  isCommon        Boolean       @default(false)
  createdAt       DateTime      @default(now())
  qualification   Qualification @relation(fields: [qualificationId], references: [id], onDelete: Cascade)

  @@unique([qualificationId, alias])
  @@index([alias])
  @@map("qualification_aliases")
}

/// *
/// * QualificationCountryProfile
/// * Country-specific information for qualifications
model QualificationCountryProfile {
  id                  String        @id @default(cuid())
  qualificationId     String
  countryCode         String
  regulatedTitle      String?
  issuingBody         String?
  accreditationStatus String?
  notes               String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  country             Country       @relation(fields: [countryCode], references: [code])
  qualification       Qualification @relation(fields: [qualificationId], references: [id], onDelete: Cascade)

  @@unique([qualificationId, countryCode])
  @@index([countryCode])
  @@map("qualification_country_profiles")
}

/// *
/// * QualificationEquivalency
/// * Cross-qualification equivalence mapping
model QualificationEquivalency {
  id                  String        @id @default(cuid())
  fromQualificationId String
  toQualificationId   String
  countryCode         String?
  isEquivalent        Boolean       @default(true)
  notes               String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  country             Country?      @relation(fields: [countryCode], references: [code])
  fromQualification   Qualification @relation("FromQualification", fields: [fromQualificationId], references: [id], onDelete: Cascade)
  toQualification     Qualification @relation("ToQualification", fields: [toQualificationId], references: [id], onDelete: Cascade)

  @@unique([fromQualificationId, toQualificationId, countryCode])
  @@index([fromQualificationId])
  @@index([toQualificationId])
  @@map("qualification_equivalencies")
}

/// *
/// * RoleRecommendedQualification
/// * Mapping of recommended qualifications for specific roles
model RoleRecommendedQualification {
  id              String        @id @default(cuid())
  roleId          String
  qualificationId String
  weight          Int           @default(1)
  countryCode     String?
  isPreferred     Boolean       @default(false)
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  country         Country?      @relation(fields: [countryCode], references: [code])
  qualification   Qualification @relation(fields: [qualificationId], references: [id], onDelete: Cascade)
  role            RoleCatalog   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, qualificationId, countryCode])
  @@index([roleId])
  @@index([qualificationId])
  @@index([weight])
  @@map("role_recommended_qualifications")
}

/// *
/// * RoleNeededEducationRequirement
/// * Junction table linking RoleNeeded to specific Qualifications
/// * Replaces free-text educationRequirements with normalized IDs
model RoleNeededEducationRequirement {
  id              String        @id @default(cuid())
  roleNeededId    String
  qualificationId String
  mandatory       Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  qualification   Qualification @relation(fields: [qualificationId], references: [id], onDelete: Cascade)
  roleNeeded      RoleNeeded    @relation(fields: [roleNeededId], references: [id], onDelete: Cascade)

  @@unique([roleNeededId, qualificationId])
  @@index([roleNeededId])
  @@index([qualificationId])
  @@map("role_needed_education_requirements")
}

model AuditLog {
  id         String   @id @default(cuid())
  actionType String
  entityId   String
  entityType String
  userId     String
  changes    Json     @default("{}")
  timestamp  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model AllocationCursor {
  id           String   @id @default(cuid())
  projectId    String
  roleNeededId String
  lastIndex    Int      @default(0)
  updatedAt    DateTime @updatedAt

  @@unique([projectId, roleNeededId])
  @@map("allocation_cursors")
}

enum ClientType {
  INDIVIDUAL
  SUB_AGENCY
  HEALTHCARE_ORGANIZATION
  EXTERNAL_SOURCE
}

enum IndividualRelationship {
  CURRENT_EMPLOYEE
  FORMER_EMPLOYEE
  NETWORK_CONTACT
}

enum AgencyType {
  LOCAL
  REGIONAL
  SPECIALIZED
}

enum FacilityType {
  HOSPITAL
  CLINIC
  NURSING_HOME
  MEDICAL_CENTER
}

enum FacilitySize {
  SMALL
  MEDIUM
  LARGE
}

enum ExternalSourceType {
  JOB_BOARD
  SOCIAL_MEDIA
  REFERRAL_PLATFORM
  INDUSTRY_EVENT
  COLD_OUTREACH
  OTHER
}

enum AcquisitionMethod {
  ORGANIC
  PAID
  PARTNERSHIP
  REFERRAL
}

enum RelationshipType {
  REFERRAL
  PARTNERSHIP
  DIRECT_CLIENT
  EXTERNAL_SOURCE
}

enum QualificationLevel {
  CERTIFICATE
  DIPLOMA
  BACHELOR
  MASTER
  DOCTORATE
}

model Religion {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("religions")
}

model State {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  countryCode String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("states")
}

model CandidateRecruiterAssignment {
  id             String    @id @default(cuid())
  candidateId    String
  recruiterId    String
  assignedBy     String
  assignedAt     DateTime  @default(now())
  unassignedAt   DateTime?
  unassignedBy   String?
  reason         String? // Reason for assignment change
  isActive       Boolean   @default(true)
  assignmentType String    @default("manual") // manual, cre_auto, cre_manual
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  candidate        Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  recruiter        User      @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  assignedByUser   User      @relation("AssignedByUser", fields: [assignedBy], references: [id])
  unassignedByUser User?     @relation("UnassignedByUser", fields: [unassignedBy], references: [id])

  @@index([candidateId])
  @@index([recruiterId])
  @@index([isActive])
  @@index([assignmentType])
  @@map("candidate_recruiter_assignments")
}

model CandidateStatus {
  id         Int      @id @default(autoincrement())
  statusName String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  candidates Candidate[]

  statusHistories CandidateStatusHistory[] @relation("StatusToHistory")

  @@map("candidate_status")
}

model CandidateProjectStatus {
  id          Int      @id @default(autoincrement())
  statusName  String   @unique
  label       String
  description String?
  stage       String // nomination, documents, approval, interview, selection, processing, final, rejected, withdrawn, on_hold
  isTerminal  Boolean  @default(false)
  color       String? // For UI representation
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  currentCandidateProjects CandidateProjects[] @relation("CurrentProjectStatus")

  @@index([stage])
  @@index([isTerminal])
  @@map("candidate_project_status")
}

/// *
/// * CandidateProjectStatusHistory
/// * Tracks status changes for candidates in specific projects
/// * Records who changed the status, when, and why
model CandidateProjectStatusHistory {
  id String @id @default(cuid())

  candidateProjectMapId String
  candidateProjectMap   CandidateProjects @relation(fields: [candidateProjectMapId], references: [id], onDelete: Cascade)

  // Who changed the status
  changedById   String?
  changedBy     User?   @relation("UserToProjectStatusHistory", fields: [changedById], references: [id])
  changedByName String?

  // NEW STATUS SYSTEM
  mainStatusId String?
  mainStatus   CandidateProjectMainStatus? @relation(fields: [mainStatusId], references: [id])

  subStatusId String?
  subStatus   CandidateProjectSubStatus? @relation(fields: [subStatusId], references: [id])

  // Snapshots for fast UI rendering (avoid extra joins)
  mainStatusSnapshot String?
  subStatusSnapshot  String?

  reason String? @db.Text
  notes  String? @db.Text

  statusChangedAt DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([candidateProjectMapId])
  @@index([changedById])
  @@index([mainStatusId])
  @@index([subStatusId])
  @@index([statusChangedAt])
  @@map("candidate_project_status_history")
}

model CandidateStatusHistory {
  id String @id @default(cuid())

  candidateId String
  candidate   Candidate @relation("CandidateToHistory", fields: [candidateId], references: [id], onDelete: Cascade)

  changedById String?
  changedBy   User?   @relation("UserToHistory", fields: [changedById], references: [id])

  changedByName String? // snapshot of who changed it (optional, for quick read)

  statusId           Int
  status             CandidateStatus @relation("StatusToHistory", fields: [statusId], references: [id])
  statusNameSnapshot String

  reason String? @db.Text // Reason for status change (optional, supports long text)

  notificationCount Int       @default(0)
  lastNotifiedAt    DateTime?
  statusUpdatedAt   DateTime  @default(now())

  rnrReminders RNRReminder[]

  @@index([candidateId])
  @@index([changedById])
  @@map("candidate_status_history")
}

model RNRReminder {
  id              String @id @default(cuid())
  candidateId     String
  recruiterId     String // The recruiter who needs to be reminded
  statusHistoryId String // Link to the RNR status change

  scheduledFor DateTime // When to send reminder (4 hours from RNR)
  sentAt       DateTime? // When reminder was actually sent

  reminderCount    Int      @default(0) // Total reminders sent across all days
  dailyCount       Int      @default(0) // How many sent today (resets each day)
  daysCompleted    Int      @default(0) // How many days completed (0-3)
  lastReminderDate DateTime @default(now()) // Track the day

  status String @default("pending") // pending, completed, cancelled

  // CRE (Candidate Recruitment Employee) Assignment tracking
  creAssigned   Boolean   @default(false) // Was this assigned to CRE after 3 days?
  creAssignedAt DateTime? // When was it assigned to CRE
  creAssignedTo String? // Which CRE user ID got assigned

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  candidate     Candidate              @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  recruiter     User                   @relation("RecruiterRNRReminders", fields: [recruiterId], references: [id], onDelete: Cascade)
  statusHistory CandidateStatusHistory @relation(fields: [statusHistoryId], references: [id], onDelete: Cascade)

  @@index([scheduledFor, status])
  @@index([recruiterId, status])
  @@index([candidateId])
  @@index([daysCompleted, status])
  @@map("rnr_reminders")
}

/// System-wide configuration settings
/// Stores JSON configuration for various features
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique // e.g., "RNR_SETTINGS", "EMAIL_CONFIG"
  value       Json // Configuration as JSON object
  description String? // Optional description of this config
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([isActive])
  @@map("system_config")
}

model CandidateProjectMainStatus {
  id          String   @id @default(cuid())
  name        String   @unique
  label       String
  color       String?
  order       Int
  icon        String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subStatuses       CandidateProjectSubStatus[]
  candidateProjects CandidateProjects[]
  statusHistory     CandidateProjectStatusHistory[]

  @@map("candidate_project_main_statuses")
}

model CandidateProjectSubStatus {
  id          String  @id @default(cuid())
  name        String  @unique
  label       String
  description String?
  color       String?
  order       Int
  icon        String?

  stageId String
  stage   CandidateProjectMainStatus @relation(fields: [stageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  candidateProjects CandidateProjects[]
  statusHistory     CandidateProjectStatusHistory[]

  @@map("candidate_project_sub_statuses")
}
